<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Simulator - Interactive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
        }

        /* Input Panel */
        .input-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .input-panel h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .input-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .input-group h3 {
            margin: 0 0 12px 0;
            font-size: 0.95em;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-row:last-child {
            margin-bottom: 0;
        }
        .input-row label {
            flex: 1;
            font-size: 0.9em;
            color: #666;
        }
        .input-row input {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            text-align: right;
        }
        .input-row input:focus {
            outline: none;
            border-color: #3498db;
        }
        .euro-prefix {
            position: relative;
        }
        .euro-prefix::before {
            content: "€k";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 0.9em;
        }
        .euro-prefix input {
            padding-left: 32px;
        }
        .pct-suffix {
            position: relative;
        }
        .pct-suffix::after {
            content: "%";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        .pct-suffix input {
            padding-right: 28px;
        }

        /* Slider */
        .slider-group {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fc;
            border-radius: 8px;
        }
        .slider-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .slider-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        .slider-value {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        /* Run Button */
        .run-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        #runSimulation {
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #runSimulation:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        #runSimulation:active {
            transform: translateY(0);
        }
        #runSimulation:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #status {
            font-size: 0.95em;
            color: #666;
        }
        #status.running {
            color: #f39c12;
        }
        #status.success {
            color: #27ae60;
        }
        #status.error {
            color: #e74c3c;
        }

        /* Results */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-value.success { color: #27ae60; }
        .stat-value.warning { color: #f39c12; }
        .stat-value.danger { color: #e74c3c; }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 5px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .chart-container canvas {
            max-height: 400px;
        }
        .params-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        .param-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .param-label {
            font-weight: 500;
            color: #555;
        }
        .failure-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .failure-item {
            padding: 10px;
            margin: 5px 0;
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
        }
        .close-call-item {
            padding: 10px;
            margin: 5px 0;
            background: #fffaf0;
            border-left: 4px solid #f39c12;
            border-radius: 4px;
        }
        .legend-note {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .mortality-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            color: white;
        }
        .mortality-section h3 {
            color: #a8d8ea;
            margin-top: 0;
            border-bottom: 2px solid #a8d8ea;
            padding-bottom: 10px;
        }
        .mortality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .mortality-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .mortality-card .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #a8d8ea;
        }
        .mortality-card .stat-value.real-success { color: #2ecc71; }
        .mortality-card .stat-value.died-ok { color: #f39c12; }
        .mortality-card .stat-value.real-fail { color: #e74c3c; }
        .mortality-card .stat-label {
            color: #ccc;
            font-size: 0.85em;
            margin-top: 5px;
        }
        .mortality-note {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            border-left: 3px solid #a8d8ea;
        }
        .mortality-disabled {
            color: #888;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        /* Initial state */
        #results {
            display: none;
        }
        .initial-message {
            text-align: center;
            padding: 60px 20px;
            color: #888;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <h1>FIRE Simulator</h1>

    <!-- Input Panel -->
    <div class="input-panel">
        <h2>Simulation Parameters</h2>

        <div class="input-grid">
            <div class="input-group">
                <h3>Portfolio & Expenses</h3>
                <div class="input-row">
                    <label>Starting Portfolio</label>
                    <div class="euro-prefix">
                        <input type="number" id="starting_portfolio" value="1200" step="10">
                    </div>
                </div>
                <div class="input-row">
                    <label>Annual Expenses</label>
                    <div class="euro-prefix">
                        <input type="number" id="annual_expenses" value="32.5" step="0.5">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h3>Income Phases (per year)</h3>
                <div class="input-row">
                    <label>RGT + Trading (47-57)</label>
                    <div class="euro-prefix">
                        <input type="number" id="income_rgt" value="17" step="1">
                    </div>
                </div>
                <div class="input-row">
                    <label>Trading only (58-64)</label>
                    <div class="euro-prefix">
                        <input type="number" id="income_trading" value="10" step="1">
                    </div>
                </div>
                <div class="input-row">
                    <label>Kansaneläke (65+)</label>
                    <div class="euro-prefix">
                        <input type="number" id="income_pension" value="8.4" step="0.1">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h3>Windfalls</h3>
                <div class="input-row">
                    <label>Inheritance (age 55)</label>
                    <div class="euro-prefix">
                        <input type="number" id="inheritance" value="200" step="10">
                    </div>
                </div>
                <div class="input-row">
                    <label>RGT Liquidation (age 58)</label>
                    <div class="euro-prefix">
                        <input type="number" id="rgt_liquidation" value="60" step="5">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h3>Emergency Responses</h3>
                <div class="input-row">
                    <label>Hustle Income (if triggered)</label>
                    <div class="euro-prefix">
                        <input type="number" id="hustle_income" value="40" step="5">
                    </div>
                </div>
                <div class="input-row">
                    <label>Reduced Spending</label>
                    <div class="euro-prefix">
                        <input type="number" id="reduced_spending" value="25" step="1">
                    </div>
                </div>
                <div class="input-row">
                    <label>Lean Spending</label>
                    <div class="euro-prefix">
                        <input type="number" id="lean_spending" value="17" step="1">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h3>Time Horizon</h3>
                <div class="input-row">
                    <label>Start Age (FIRE)</label>
                    <input type="number" id="start_age" value="47" min="30" max="60">
                </div>
                <div class="input-row">
                    <label>End Age (survival)</label>
                    <input type="number" id="end_age" value="95" min="70" max="110">
                </div>
                <div class="input-row">
                    <label>Inheritance Age</label>
                    <input type="number" id="inheritance_age" value="55" min="47" max="90">
                </div>
                <div class="input-row">
                    <label>Pension Start Age</label>
                    <input type="number" id="pension_start_age" value="65" min="60" max="75">
                </div>
            </div>

            <div class="input-group">
                <h3>Investment Assumptions</h3>
                <div class="input-row">
                    <label>Expected Return</label>
                    <div class="pct-suffix">
                        <input type="number" id="expected_return" value="6" step="0.5" min="0" max="15">
                    </div>
                </div>
                <div class="input-row">
                    <label>Inflation</label>
                    <div class="pct-suffix">
                        <input type="number" id="inflation" value="2" step="0.5" min="0" max="10">
                    </div>
                </div>
                <div class="input-row">
                    <label>Volatility (std dev)</label>
                    <div class="pct-suffix">
                        <input type="number" id="volatility" value="15" step="1" min="5" max="30">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h3>Emergency Hustle Rules</h3>
                <div class="input-row">
                    <label>Trigger until age</label>
                    <input type="number" id="hustle_trigger_age_max" value="52" min="47" max="65">
                </div>
                <div class="input-row">
                    <label>Duration (years)</label>
                    <input type="number" id="hustle_duration" value="3" min="1" max="10">
                </div>
                <div class="input-row">
                    <label>Portfolio threshold</label>
                    <div class="pct-suffix">
                        <input type="number" id="hustle_portfolio_threshold" value="70" step="5" min="30" max="90">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h3>Spending Rules</h3>
                <div class="input-row">
                    <label>Drop threshold</label>
                    <div class="pct-suffix">
                        <input type="number" id="spending_drop_threshold" value="50" step="5" min="20" max="80">
                    </div>
                </div>
                <div class="input-row">
                    <label>Recovery threshold</label>
                    <div class="pct-suffix">
                        <input type="number" id="spending_recovery_threshold" value="60" step="5" min="30" max="90">
                    </div>
                </div>
                <div class="input-row">
                    <label>Lean mode age</label>
                    <input type="number" id="lean_age" value="60" min="50" max="75">
                </div>
            </div>

            <div class="input-group">
                <h3>Mortality Modeling</h3>
                <div class="input-row">
                    <label>Healthy lifestyle factor</label>
                    <input type="number" id="healthy_lifestyle_factor" value="0.65" step="0.05" min="0.4" max="1.0">
                </div>
            </div>
        </div>

        <div class="slider-group">
            <label>Number of Simulations</label>
            <input type="range" id="num_simulations" min="1000" max="100000" step="1000" value="1000">
            <div class="slider-value"><span id="simCount">1000</span> simulations</div>
        </div>

        <div class="run-section">
            <button id="runSimulation">Run Simulation</button>
            <span id="status"></span>
        </div>
    </div>

    <!-- Initial message -->
    <div id="initialMessage" class="initial-message">
        Adjust the parameters above and click <strong>Run Simulation</strong> to see results.
    </div>

    <!-- Results (hidden initially) -->
    <div id="results">
        <!-- Mortality-Adjusted Results -->
        <div class="mortality-section" id="mortalitySection"></div>

        <!-- Summary Stats -->
        <h2>Portfolio Success (Ignoring Mortality)</h2>
        <div class="summary-grid" id="summary"></div>

        <!-- Parameters -->
        <div class="params-section">
            <h3>Simulation Parameters</h3>
            <div class="params-grid" id="params"></div>
        </div>

        <!-- Fan Chart -->
        <h2>Portfolio Trajectories (All Percentiles)</h2>
        <div class="chart-container">
            <canvas id="fanChart"></canvas>
            <div class="legend-note">
                The shaded areas show the range of outcomes. The darker the shade, the more likely.
                Middle line (50th percentile) = median outcome. Outer edges = best/worst 5%.
            </div>
        </div>

        <!-- Failure Chart -->
        <h2>Failure Analysis (Bottom 5%)</h2>
        <div class="chart-container">
            <canvas id="failureChart"></canvas>
            <div class="legend-note">
                Each line represents a simulation that ran out of money. Earlier failures (steeper drops) are more concerning.
            </div>
        </div>

        <!-- Close Calls -->
        <h2>Close Calls (Survived but Scary)</h2>
        <div class="chart-container">
            <canvas id="closeCallChart"></canvas>
        </div>

        <!-- Failure List -->
        <h2>Failure Details</h2>
        <div class="failure-list" id="failureList"></div>
    </div>

    <script>
        // Global chart references
        let fanChart = null;
        let failureChart = null;
        let closeCallChart = null;

        // Update slider display
        document.getElementById('num_simulations').addEventListener('input', (e) => {
            document.getElementById('simCount').textContent = e.target.value;
        });

        // Format currency
        function formatCurrency(amount) {
            return '€' + Math.round(amount).toLocaleString();
        }

        // Get input value as integer
        // Get euro input value (stored in thousands, convert to full amount)
        function getInputValue(id) {
            return Math.round(parseFloat(document.getElementById(id).value) * 1000) || 0;
        }

        // Get age/count input value (no multiplication needed)
        function getIntValue(id) {
            return parseInt(document.getElementById(id).value) || 0;
        }

        // Run simulation
        document.getElementById('runSimulation').addEventListener('click', async () => {
            const button = document.getElementById('runSimulation');
            const status = document.getElementById('status');

            // Disable button and show status
            button.disabled = true;
            status.textContent = 'Running simulation...';
            status.className = 'running';

            const startAge = getIntValue('start_age');
            const endAge = getIntValue('end_age');
            const pensionAge = getIntValue('pension_start_age');

            const params = {
                starting_portfolio: getInputValue('starting_portfolio'),
                annual_expenses: getInputValue('annual_expenses'),
                start_age: startAge,
                end_age: endAge,
                expected_return: parseFloat(document.getElementById('expected_return').value) / 100,
                inflation: parseFloat(document.getElementById('inflation').value) / 100,
                volatility: parseFloat(document.getElementById('volatility').value) / 100,
                income_phases: [
                    { start_age: startAge, end_age: 57, amount: getInputValue('income_rgt'), name: 'RGT + trading' },
                    { start_age: 58, end_age: pensionAge - 1, amount: getInputValue('income_trading'), name: 'Trading only' },
                    { start_age: pensionAge, end_age: endAge, amount: getInputValue('income_pension'), name: 'Kansaneläke' }
                ],
                windfalls: [
                    { age: getIntValue('inheritance_age'), amount: getInputValue('inheritance'), name: 'Inheritance' },
                    { age: 58, amount: getInputValue('rgt_liquidation'), name: 'RGT liquidation' }
                ],
                emergency_hustle: {
                    enabled: true,
                    trigger_age_max: getIntValue('hustle_trigger_age_max'),
                    portfolio_threshold: parseFloat(document.getElementById('hustle_portfolio_threshold').value) / 100,
                    extra_income: getInputValue('hustle_income'),
                    duration: getIntValue('hustle_duration')
                },
                spending_rules: {
                    enabled: true,
                    drop_threshold: parseFloat(document.getElementById('spending_drop_threshold').value) / 100,
                    recovery_threshold: parseFloat(document.getElementById('spending_recovery_threshold').value) / 100,
                    reduced_spending: getInputValue('reduced_spending'),
                    lean_spending: getInputValue('lean_spending'),
                    lean_age: getIntValue('lean_age')
                },
                mortality: {
                    enabled: true,
                    healthy_lifestyle_factor: parseFloat(document.getElementById('healthy_lifestyle_factor').value)
                },
                num_simulations: getIntValue('num_simulations')
            };

            try {
                const startTime = Date.now();
                const response = await fetch('api/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

                // Hide initial message, show results
                document.getElementById('initialMessage').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                // Destroy existing charts
                if (fanChart) { fanChart.destroy(); fanChart = null; }
                if (failureChart) { failureChart.destroy(); failureChart = null; }
                if (closeCallChart) { closeCallChart.destroy(); closeCallChart = null; }

                // Reset chart containers
                resetChartContainers();

                // Render all sections
                renderMortality(data);
                renderSummary(data);
                renderParams(data);
                renderFanChart(data);
                renderFailureChart(data);
                renderCloseCallChart(data);
                renderFailureList(data);

                status.textContent = `Completed in ${elapsed}s - ${data.params.num_simulations} simulations`;
                status.className = 'success';

            } catch (error) {
                status.textContent = 'Error: ' + error.message;
                status.className = 'error';
                console.error('Simulation error:', error);
            }

            button.disabled = false;
        });

        // Reset chart containers that may have been replaced with text
        function resetChartContainers() {
            const chartIds = ['fanChart', 'failureChart', 'closeCallChart'];
            chartIds.forEach(id => {
                const container = document.getElementById(id)?.parentElement;
                if (container && !document.getElementById(id)) {
                    const canvas = document.createElement('canvas');
                    canvas.id = id;
                    const legend = container.querySelector('.legend-note');
                    if (legend) {
                        container.insertBefore(canvas, legend);
                    } else {
                        container.innerHTML = '';
                        container.appendChild(canvas);
                    }
                }
            });
        }

        function renderMortality(data) {
            const s = data.summary;
            const container = document.getElementById('mortalitySection');

            if (!s.mortality_enabled) {
                container.innerHTML = `
                    <h3>Mortality Modeling</h3>
                    <div class="mortality-disabled">
                        Mortality modeling is disabled in server config.
                    </div>
                `;
                return;
            }

            const p = data.params;
            const total = p.num_simulations;
            const survivedPct = (s.survived_to_end / total * 100).toFixed(1);
            const diedOkPct = (s.died_with_money / total * 100).toFixed(1);
            const ranOutPct = (s.ran_out_of_money / total * 100).toFixed(1);
            const realFailPct = (s.real_failure_rate * 100).toFixed(2);

            container.innerHTML = `
                <h3>Realistic Outcomes (With Mortality)</h3>
                <div class="mortality-grid">
                    <div class="mortality-card">
                        <div class="stat-value real-success">${survivedPct}%</div>
                        <div class="stat-label">Survived to ${p.end_age} with Money</div>
                    </div>
                    <div class="mortality-card">
                        <div class="stat-value died-ok">${diedOkPct}%</div>
                        <div class="stat-label">Died Naturally with Money</div>
                    </div>
                    <div class="mortality-card">
                        <div class="stat-value real-fail">${ranOutPct}%</div>
                        <div class="stat-label">Ran Out While Alive</div>
                    </div>
                    <div class="mortality-card">
                        <div class="stat-value" style="color: #fff;">${realFailPct}%</div>
                        <div class="stat-label">REAL Failure Rate</div>
                    </div>
                    <div class="mortality-card">
                        <div class="stat-value">${(s.theoretical_survival_to_end * 100).toFixed(1)}%</div>
                        <div class="stat-label">P(Survive to ${p.end_age})</div>
                    </div>
                    <div class="mortality-card">
                        <div class="stat-value">${s.life_expectancy ? Math.round(p.start_age + s.life_expectancy) : 'N/A'}</div>
                        <div class="stat-label">Life Expectancy</div>
                    </div>
                </div>
                <div class="mortality-note">
                    <strong>How to read this:</strong> Using Finnish male mortality tables (${s.healthy_lifestyle_factor < 1 ? 'adjusted for healthy lifestyle factor ' + s.healthy_lifestyle_factor : 'population average'}),
                    we sample a random death age for each simulation. The "real failure rate" only counts
                    simulations where you ran out of money while still alive.
                </div>
            `;
        }

        function renderSummary(data) {
            const s = data.summary;
            const successClass = s.success_rate >= 0.95 ? 'success' : s.success_rate >= 0.90 ? 'warning' : 'danger';

            document.getElementById('summary').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value ${successClass}">${(s.success_rate * 100).toFixed(1)}%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${s.failure_count}</div>
                    <div class="stat-label">Failed Simulations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(s.median_final)}</div>
                    <div class="stat-label">Median Final Portfolio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${s.avg_ruin_age ? Math.round(s.avg_ruin_age) : 'N/A'}</div>
                    <div class="stat-label">Avg Ruin Age (failures)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(s.hustle_activation_rate * 100).toFixed(1)}%</div>
                    <div class="stat-label">Hustle Triggered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(s.spending_reduction_rate * 100).toFixed(1)}%</div>
                    <div class="stat-label">Spending Reduced</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(s.lean_mode_rate * 100).toFixed(1)}%</div>
                    <div class="stat-label">Lean Mode</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(s.percentile_5_final)}</div>
                    <div class="stat-label">5th Percentile Final</div>
                </div>
            `;
        }

        function renderParams(data) {
            const p = data.params;
            const phases = p.income_phases.map(ph =>
                `Age ${ph.start_age}-${ph.end_age}: €${ph.amount.toLocaleString()} (${ph.name})`
            ).join('<br>');

            const windfalls = p.windfalls.map(w =>
                `Age ${w.age}: €${w.amount.toLocaleString()} (${w.name})`
            ).join('<br>');

            const spendingRules = p.spending_rules && p.spending_rules.enabled ?
                `Drop to €${p.spending_rules.reduced_spending?.toLocaleString() || '25,000'} at ${(p.spending_rules.drop_threshold * 100)}% portfolio<br>` +
                `Lean €${p.spending_rules.lean_spending?.toLocaleString() || '17,000'} available at age ${p.spending_rules.lean_age || 60}+<br>` +
                `Recovery at ${(p.spending_rules.recovery_threshold * 100)}% portfolio` :
                'Disabled';

            document.getElementById('params').innerHTML = `
                <div class="param-item">
                    <span class="param-label">Starting Portfolio:</span> ${formatCurrency(p.starting_portfolio)}
                </div>
                <div class="param-item">
                    <span class="param-label">Annual Expenses:</span> ${formatCurrency(p.annual_expenses)}
                </div>
                <div class="param-item">
                    <span class="param-label">Time Horizon:</span> Age ${p.start_age} to ${p.end_age}
                </div>
                <div class="param-item">
                    <span class="param-label">Expected Return:</span> ${(p.expected_return * 100).toFixed(0)}%
                </div>
                <div class="param-item">
                    <span class="param-label">Inflation:</span> ${(p.inflation * 100).toFixed(0)}%
                </div>
                <div class="param-item">
                    <span class="param-label">Volatility:</span> ${(p.volatility * 100).toFixed(0)}%
                </div>
                <div class="param-item">
                    <span class="param-label">Income Phases:</span><br>${phases}
                </div>
                <div class="param-item">
                    <span class="param-label">Windfalls:</span><br>${windfalls}
                </div>
                <div class="param-item">
                    <span class="param-label">Spending Rules:</span><br>${spendingRules}
                </div>
            `;
        }

        function renderFanChart(data) {
            const ctx = document.getElementById('fanChart').getContext('2d');
            const perc = data.percentiles;

            fanChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: perc.ages,
                    datasets: [
                        {
                            label: '5th-95th percentile',
                            data: perc.p95,
                            fill: '+5',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderColor: 'rgba(52, 152, 219, 0.3)',
                            borderWidth: 1,
                            pointRadius: 0
                        },
                        {
                            label: '',
                            data: perc.p5,
                            fill: false,
                            borderColor: 'rgba(52, 152, 219, 0.3)',
                            borderWidth: 1,
                            pointRadius: 0
                        },
                        {
                            label: '15th-75th percentile',
                            data: perc.p75,
                            fill: '+1',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderColor: 'rgba(52, 152, 219, 0.4)',
                            borderWidth: 1,
                            pointRadius: 0
                        },
                        {
                            label: '',
                            data: perc.p15,
                            fill: false,
                            borderColor: 'rgba(52, 152, 219, 0.4)',
                            borderWidth: 1,
                            pointRadius: 0
                        },
                        {
                            label: '25th-75th percentile',
                            data: perc.p75,
                            fill: '+1',
                            backgroundColor: 'rgba(52, 152, 219, 0.3)',
                            borderColor: 'transparent',
                            borderWidth: 0,
                            pointRadius: 0
                        },
                        {
                            label: '',
                            data: perc.p25,
                            fill: false,
                            borderColor: 'transparent',
                            borderWidth: 0,
                            pointRadius: 0
                        },
                        {
                            label: 'Median (50th)',
                            data: perc.p50,
                            fill: false,
                            borderColor: 'rgba(41, 128, 185, 1)',
                            borderWidth: 3,
                            pointRadius: 0
                        },
                        {
                            label: '10th percentile',
                            data: perc.p10,
                            fill: false,
                            borderColor: 'rgba(231, 76, 60, 0.7)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                filter: (item) => item.text !== ''
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Age' }
                        },
                        y: {
                            title: { display: true, text: 'Portfolio Value' },
                            ticks: {
                                callback: (value) => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function renderFailureChart(data) {
            const ctx = document.getElementById('failureChart').getContext('2d');
            const failures = data.failures.slice(0, 15);

            if (failures.length === 0) {
                ctx.canvas.parentElement.querySelector('canvas').outerHTML =
                    '<p style="text-align: center; color: #27ae60; padding: 40px;">No failures! All simulations succeeded.</p>';
                return;
            }

            const colors = [
                'rgba(231, 76, 60, 0.7)',
                'rgba(192, 57, 43, 0.7)',
                'rgba(155, 89, 182, 0.7)',
                'rgba(142, 68, 173, 0.7)',
                'rgba(211, 84, 0, 0.7)'
            ];

            const datasets = failures.map((f, i) => ({
                label: `Failed at ${f.ruin_age}`,
                data: f.trajectory,
                fill: false,
                borderColor: colors[i % colors.length],
                borderWidth: 2,
                pointRadius: 0
            }));

            failureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: failures[0]?.ages || [],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Age' }
                        },
                        y: {
                            title: { display: true, text: 'Portfolio Value' },
                            ticks: {
                                callback: (value) => formatCurrency(value)
                            },
                            min: 0
                        }
                    }
                }
            });
        }

        function renderCloseCallChart(data) {
            const ctx = document.getElementById('closeCallChart').getContext('2d');
            const closeCalls = data.close_calls.slice(0, 10);

            if (closeCalls.length === 0) {
                ctx.canvas.parentElement.querySelector('canvas').outerHTML =
                    '<p style="text-align: center; color: #888; padding: 40px;">No close calls - all survivors maintained healthy portfolios.</p>';
                return;
            }

            const datasets = closeCalls.map((cc, i) => ({
                label: `Min €${Math.round(cc.min_value/1000)}k at age ${cc.min_age}`,
                data: cc.trajectory,
                fill: false,
                borderColor: `hsla(${40 + i * 10}, 80%, 50%, 0.7)`,
                borderWidth: 2,
                pointRadius: 0
            }));

            closeCallChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: closeCalls[0]?.ages || [],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Age' }
                        },
                        y: {
                            title: { display: true, text: 'Portfolio Value' },
                            ticks: {
                                callback: (value) => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function renderFailureList(data) {
            const container = document.getElementById('failureList');
            const failures = data.failures;
            const closeCalls = data.close_calls;

            let html = '<h3>Failed Simulations</h3>';
            if (failures.length === 0) {
                html += '<p style="color: #27ae60;">No failures in this simulation run!</p>';
            } else {
                failures.slice(0, 10).forEach(f => {
                    const hustleNote = f.hustle_activated ?
                        ` (hustle triggered at age ${f.hustle_activation_age})` : '';
                    const spendingNote = f.spending_went_lean ? ' (went lean)' :
                        (f.spending_reduced ? ' (reduced spending)' : '');
                    html += `<div class="failure-item">
                        Ran out of money at age <strong>${f.ruin_age}</strong>${hustleNote}${spendingNote}
                    </div>`;
                });
                if (failures.length > 10) {
                    html += `<p>...and ${failures.length - 10} more failures</p>`;
                }
            }

            html += '<h3 style="margin-top: 20px;">Close Calls (Survived but Got Scary)</h3>';
            if (closeCalls.length === 0) {
                html += '<p>No close calls - all survivors maintained healthy portfolios.</p>';
            } else {
                closeCalls.slice(0, 5).forEach(cc => {
                    const hustleNote = cc.hustle_activated ? ' (hustle helped!)' : '';
                    const spendingNote = cc.spending_went_lean ? ' (went lean)' :
                        (cc.spending_reduced ? ' (reduced spending)' : '');
                    html += `<div class="close-call-item">
                        Dropped to <strong>${formatCurrency(cc.min_value)}</strong> at age ${cc.min_age},
                        recovered to ${formatCurrency(cc.final_portfolio)}${hustleNote}${spendingNote}
                    </div>`;
                });
            }

            container.innerHTML = html;
        }
    </script>
</body>
</html>
